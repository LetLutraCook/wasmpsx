<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WASMpsx iPad Debugger</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <style>
        body { font-family: sans-serif; background: #111; color: #ccc; padding: 20px; }
        #log { 
            background: #000; color: #0f0; padding: 15px; 
            white-space: pre-wrap; font-family: monospace; 
            border: 1px solid #333; height: 300px; overflow-y: scroll;
        }
        .status-msg { margin-bottom: 10px; font-weight: bold; }
    </style>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            const logBox = document.getElementById("log");
            const output = `‚ùå RUNTIME ERROR: ${msg}\nLine: ${line}, Col: ${col}\n`;
            if (logBox) logBox.textContent += output;
            console.error(msg);
            return false;
        };
    </script>

    <script type="module" src="wasmpsx.min.js"></script>
</head>
<body>

    <h2>WASMpsx iPad Diagnostic</h2>

    <wasmpsx-player id="player"></wasmpsx-player>

    <div class="status-msg">System Logs:</div>
    <pre id="log">Initializing diagnostic...</pre>

    <p>
        <label style="background:#444; padding:10px; border-radius:5px; cursor:pointer;">
            üìÅ Select ROM
            <input id="romfile" type="file" style="display:none">
        </label>
    </p>

    <script>
        const logBox = document.getElementById("log");
        function log(msg) {
            logBox.textContent += msg + "\n";
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function runDeepScan() {
            log("--- Starting Deep Scan ---");

            // Check WASM Support
            const wasmSupported = typeof WebAssembly === "object";
            log(`WASM Hardware Support: ${wasmSupported ? "‚úÖ YES" : "‚ùå NO"}`);

            // Check for modern features Safari might be choking on
            log(`SharedArrayBuffer Support: ${typeof SharedArrayBuffer !== "undefined" ? "‚úÖ" : "‚ùå (Likely iPadOS < 15.4)"}`);

            // Wait 1.5 seconds to give the module time to register
            log("Waiting for wasmpsx-player registration...");
            await new Promise(r => setTimeout(r, 1500));

            const playerElement = document.getElementById("player");
            const definition = customElements.get("wasmpsx-player");

            if (definition) {
                log("‚úÖ SUCCESS: <wasmpsx-player> is registered.");
                if (playerElement.shadowRoot) {
                    log("‚úÖ SUCCESS: ShadowRoot is attached.");
                } else {
                    log("‚ö†Ô∏è WARNING: Element registered but ShadowRoot is missing.");
                }
            } else {
                log("‚ùå ERROR: <wasmpsx-player> NOT registered.");
                log("Possible cause: Syntax error in wasmpsx.min.js or missing 'wasmpsx.wasm' file.");
            }

            // Probe the actual file content to see if it's empty or blocked
            try {
                const testFetch = await fetch("wasmpsx.min.js");
                const size = (await testFetch.blob()).size;
                log(`File Check: wasmpsx.min.js is ${Math.round(size/1024)} KB`);
            } catch (e) {
                log("‚ùå FETCH ERROR: Could not read file size.");
            }
        }

        document.getElementById("romfile").addEventListener("change", (e) => {
            const file = e.target.files[0];
            const player = document.getElementById("player");
            log(`Attempting to load: ${file.name}`);
            
            if (typeof player.readFile === "function") {
                player.readFile(file);
            } else {
                log("‚ùå ERROR: player.readFile is not a function. Component is dead.");
            }
        });

        // Clear initial message and run
        logBox.textContent = "";
        runDeepScan();
    </script>
</body>
</html>
