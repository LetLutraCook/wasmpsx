<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WASMpsx Diagnostic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="wasmpsx.min.js"></script>
</head>
<body>

<h1>WASMpsx Diagnostic</h1>

<wasmpsx-player id="player"></wasmpsx-player>

<p><input id="romfile" type="file"></p>

<pre id="log" style="background:#000; color:#0f0; padding:10px; white-space:pre-wrap; font-family:monospace; min-height: 200px;"></pre>

<script>
  const logBox = document.getElementById("log");
  function log(msg) {
    logBox.textContent += msg + "\n";
    logBox.scrollTop = logBox.scrollHeight;
  }

  async function runDiagnostics() {
    log("--- System Check ---");
    
    // 1. Network Probe: Can we actually see the file?
    try {
      const resp = await fetch("wasmpsx.min.js", { method: 'HEAD' });
      if (resp.ok) {
        log(`FILE REACHABLE: wasmpsx.min.js found (MIME: ${resp.headers.get('Content-Type')})`);
      } else {
        log(`FILE MISSING: Server returned ${resp.status} for wasmpsx.min.js`);
      }
    } catch (e) {
      log("FETCH ERROR: Network blocked the probe.");
    }

    // 2. Registration Check
    const wasmpsxElementDef = customElements.get("wasmpsx-player");
    if (!wasmpsxElementDef) {
      log("ERROR: <wasmpsx-player> not registered. The JS likely crashed during execution.");
    } else {
      log("OK: <wasmpsx-player> is registered.");
    }

    // 3. Instance Check
    const player = document.getElementById("player");
    setTimeout(() => {
      if (player && player.shadowRoot) {
        log("OK: ShadowRoot detected.");
        if (typeof player.readFile === "function") {
          log("OK: player.readFile is ready.");
        } else {
          log("ERROR: API functions (readFile) missing from element.");
        }
      } else {
        log("ERROR: Element exists but no ShadowRoot. It's a 'hollow' tag.");
      }
    }, 1000);
  }

  // Handle ROM loading
  document.getElementById("romfile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    const player = document.getElementById("player");
    if (file && typeof player.readFile === "function") {
      log("Loading: " + file.name);
      player.readFile(file);
    } else {
      log("Action failed: readFile is not a function.");
    }
  });

  // Global error capture for Safari/iPad
  window.onerror = function(msg, url, line) {
    log(`CRITICAL JS ERROR: ${msg} (Line: ${line})`);
    return false;
  };

  runDiagnostics();
</script>

</body>
</html>
