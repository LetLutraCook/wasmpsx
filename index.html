<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WASMpsx Final Stage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="coi-serviceworker.min.js"></script>
</head>
<body style="background:#111; color:#0f0; font-family:monospace; padding:20px;">

    <h1>WASMpsx Emulator</h1>
    
    <wasmpsx-player id="player"></wasmpsx-player>

    <div style="margin: 20px 0;">
        <input type="file" id="romfile">
    </div>

    <div id="log" style="background:#000; border:1px solid #333; padding:15px; height:250px; overflow-y:scroll; font-size:12px;"></div>

    <script type="module">
        const logger = document.getElementById("log");
        function log(msg) {
            logger.innerHTML += `<div>${msg}</div>`;
            logger.scrollTop = logger.scrollHeight;
        }

        async function boot() {
            log("--- Booting Emulator ---");
            log(`Isolation: ${window.crossOriginIsolated ? "✅" : "❌"}`);

            // 1. Manually load the script as a module
            log("Loading wasmpsx.min.js...");
            try {
                await import('./wasmpsx.min.js');
                log("Script file executed.");
            } catch (e) {
                log(`❌ SCRIPT CRASH: ${e.message}`);
            }

            // 2. Poll for registration (up to 5 seconds)
            let attempts = 0;
            const checkReg = setInterval(() => {
                attempts++;
                const isReg = customElements.get("wasmpsx-player");
                
                if (isReg) {
                    clearInterval(checkReg);
                    log("✅ SUCCESS: <wasmpsx-player> registered!");
                    setupFileListener();
                } else if (attempts > 10) {
                    clearInterval(checkReg);
                    log("❌ FAIL: Element registration timed out.");
                    log("Is wasmpsx.wasm in the root folder?");
                } else {
                    log("Waiting for registration...");
                }
            }, 500);
        }

        function setupFileListener() {
            document.getElementById("romfile").onchange = (e) => {
                const p = document.getElementById("player");
                if (p && typeof p.readFile === "function") {
                    log("Starting ROM: " + e.target.files[0].name);
                    p.readFile(e.target.files[0]);
                } else {
                    log("❌ API ERROR: Custom element exists but .readFile() is missing.");
                }
            };
        }

        boot();
    </script>
</body>
</html>
